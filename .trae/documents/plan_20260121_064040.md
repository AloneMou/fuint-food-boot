
# Refactor DTO Architecture Plan

This plan outlines the steps to implement a completely new Data Transfer Object (DTO) architecture for the project, focusing on the `Order` module as the pilot. The goal is to replace the existing inheritance-based, reflection-heavy implementation with a performance-oriented, type-safe, and composable design.

## 1. Environment & Dependencies Preparation
**Objective**: Enable compile-time code generation and modern testing.
-   **Modify `pom.xml`**:
    -   Add `mapstruct` (1.5.x) and `mapstruct-processor` dependencies.
    -   Ensure `lombok` and `mapstruct-processor` are configured correctly in the `maven-compiler-plugin` annotation processor paths to work together.
    -   Verify `spring-boot-starter-validation` is available (implied by web starter, but ensures explicit availability).

## 2. New Architecture Design (Package: `com.fuint.openapi.dto`)
**Objective**: Establish a clean, interface-driven structure detached from legacy code.
-   **Package Structure**:
    -   `com.fuint.openapi.dto.core` (Base interfaces)
    -   `com.fuint.openapi.dto.order.req` (Request DTOs)
    -   `com.fuint.openapi.dto.order.resp` (Response DTOs)
    -   `com.fuint.openapi.dto.mapper` (MapStruct Mappers)
-   **Core Definitions**:
    -   **Interfaces**: `RequestDTO`, `ResponseDTO` (Marker interfaces for type safety).
    -   **Pagination**: `PaginationQuery` (Composition-based DTO, not a superclass).
    -   **Validation**: Define `CreateGroup`, `UpdateGroup` interfaces for targeted validation.

## 3. Implementation: Order Module Pilot
**Objective**: Re-implement Order DTOs using the new pattern.
-   **Request DTOs**:
    -   `OrderCreateReqDTO`: Use Lombok `@Data` + `@Builder`. Implement `RequestDTO`.
    -   Use `javax.validation` annotations (`@NotNull`, `@Size`) with Groups.
-   **Response DTOs**:
    -   `OrderDetailRespDTO`: Flat structure, optimized for frontend consumption.
-   **Mappers**:
    -   `OrderMapper` (Interface): Use `@Mapper(componentModel = "spring")`.
    -   Define methods: `toEntity`, `toRespDTO`.
    -   Use `@Mapping` to handle field divergences explicitly (no reflection).

## 4. Service & Controller Integration
**Objective**: Connect the new DTOs to the existing business logic.
-   **Refactor `OpenApiOrderService`**:
    -   Add methods accepting `OrderCreateReqDTO` and returning `OrderDetailRespDTO`.
-   **Refactor `OpenOrderController`**:
    -   Update endpoints to use the new DTOs.
    -   Ensure `@Validated` is used with the correct Group.

## 5. Testing & Verification
**Objective**: Ensure 100% coverage and functional correctness.
-   **Unit Tests**:
    -   `OrderMapperTest`: Verify mapping correctness (Entity <-> DTO).
    -   `OrderValidationTest`: Verify validation constraints trigger correctly.
    -   `OrderJsonTest`: Verify serialization/deserialization (date formats, masking).

## 6. Documentation
**Objective**: Provide a guide for future developers.
-   **Create `DTO_ARCHITECTURE.md`**:
    -   Explain the "Composition over Inheritance" choice.
    -   Guide on using MapStruct.
    -   Benchmarks/Performance reasoning (Compile-time vs Reflection).
