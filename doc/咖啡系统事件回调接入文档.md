# 咖啡系统事件回调接入文档

> 版本：v1.0
> 更新日期：2026-01-24
> 对接方：国鸿咖啡系统

---

## 一、概述

本文档描述安克点餐系统接收咖啡系统事件回调的接口规范。咖啡系统在发生业务事件时，需主动调用本系统提供的回调接口，通知相关业务变更。

### 1.1 支持的事件类型

| 事件类型 | eventType 值 | 说明 |
|---------|--------------|------|
| 订单状态变更 | `order-status` | 订单状态流转时触发 |
| 可取餐通知 | `order-ready` | 咖啡制作完成可取餐时触发 |
| 支付状态变更 | `pay-status` | 支付成功/退款完成时触发 |
| 优惠券事件 | `coupon-event` | 优惠券领取/使用/过期/撤销时触发 |
| 开票结果 | `invoice-result` | 发票开具成功/失败时触发 |

---

## 二、接口规范

### 2.1 接口地址

```
POST https://{host}/api/openapi/coffee/callback/{eventType}
```

**生产环境**: `https://dining.anker-in.com/`
**测试环境**: `https://dining-uat.anker-in.com/`

### 2.2 请求头

| Header 名称 | 必填 | 说明 |
|------------|------|------|
| Content-Type | 是 | 固定值：`application/json` |
| X-Access-Key | 是 | 访问密钥标识（由安克提供） |
| X-Timestamp | 是 | 请求时间戳（毫秒） |
| X-Nonce | 是 | 随机字符串（32位，用于防重放） |
| X-Signature | 是 | 请求签名 |

### 2.3 签名算法

```
签名算法：HMAC-SHA256
签名密钥：secretKey（由安克提供）
签名字符串：{method}\n{path}\n{timestamp}\n{nonce}
签名结果：转为 Base64 编码字符串
```

**签名字符串说明**：
- `method`: HTTP 请求方法，固定为 `POST`
- `path`: 请求路径，如 `/api/openapi/coffee/callback/order-status`
- `timestamp`: 请求头中的 `X-Timestamp` 值
- `nonce`: 请求头中的 `X-Nonce` 值
- 各部分之间使用换行符 `\n` 连接

**Java 示例**：
```java
String method = "POST";
String path = "/api/openapi/coffee/callback/order-status";
String timestamp = "1706077353000";
String nonce = "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6";

// 拼接签名字符串
String signString = method + "\n" + path + "\n" + timestamp + "\n" + nonce;

// 计算 HMAC-SHA256 并转为 Base64
Mac mac = Mac.getInstance("HmacSHA256");
mac.init(new SecretKeySpec(secretKey.getBytes("UTF-8"), "HmacSHA256"));
byte[] hash = mac.doFinal(signString.getBytes("UTF-8"));
String signature = Base64.getEncoder().encodeToString(hash);
```

### 2.4 通用请求体结构

```json
{
  "eventId": "evt_20260124112233001",
  "eventType": "ORDER_STATUS_CHANGE",
  "eventTime": "2026-01-24 11:22:33",
  "data": { ... }
}
```

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| eventId | String | 是 | 事件唯一ID，用于幂等处理，建议格式：`evt_{timestamp}_{序列号}` |
| eventType | String | 是 | 事件类型枚举值 |
| eventTime | String | 是 | 事件发生时间，格式：`yyyy-MM-dd HH:mm:ss` |
| data | Object | 是 | 具体事件数据，不同事件类型结构不同 |

### 2.5 通用响应结构

```json
{
  "success": true,
  "code": "00000",
  "message": "success",
  "data": {
    "received": true
  },
  "traceId": "a1b2c3d4e5f6"
}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| success | Boolean | 是否成功，`true` 表示成功 |
| code | String | 状态码，`00000` 表示成功 |
| message | String | 状态描述 |
| data.received | Boolean | 是否成功接收 |
| traceId | String | 链路追踪ID，用于问题排查 |

---

## 三、事件数据结构

### 3.1 订单取餐状态变更 (ORDER_TAKE_STATUS_CHANGE)

**接口路径**: `POST /openapi/coffee/callback/order-status`

**data 结构**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| orderId | Integer | 是 | 国鸿订单ID |
| storeId | Integer | 是 | 门店ID |
| merchantId | Integer | 是 | 商户ID |
| orderSn | String | 否 | 订单编号 |
| previousStatus | String | 否 | 变更前状态 |
| currentStatus | String | 是 | 当前状态 |
| statusTime | String | 否 | 状态变更时间 |
| remark | String | 否 | 备注 |

**状态枚举**:

| 状态值 | 说明 |
|--------|------|
| PENDING | 待确认 |
| CONFIRMED | 已确认 |
| PROCESSING | 制作中 |
| READY | 可取餐 |
| COMPLETED | 已完成 |
| CANCELLED | 已取消 |

**请求示例**:
```bash
curl -X POST 'https://meal-api.example.com/openapi/coffee/callback/order-status' \
  -H 'Content-Type: application/json' \
  -H 'X-Access-Key: your_access_key' \
  -H 'X-Timestamp: 1706077353000' \
  -H 'X-Nonce: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6' \
  -H 'X-Signature: {Base64编码的签名}' \
  -d '{
    "eventId": "evt_20260124112233001",
    "eventType": "ORDER_TAKE_STATUS_CHANGE",
    "eventTime": "2026-01-24 11:22:33",
    "data": {
      "orderId": 12345,
      "merchantId": 1,
      "storeId": 1,
      "orderSn": "CF20260124001",
      "previousStatus": "CONFIRMED",
      "currentStatus": "PROCESSING",
      "statusTime": "2026-01-24 11:22:33",
      "remark": "开始制作"
    }
  }'
```

---

### 3.1 订单状态变更 (ORDER_STATUS_CHANGE)

**接口路径**: `POST /openapi/coffee/callback/order-status`

**data 结构**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| orderId | Integer | 是 | 国鸿订单ID |
| storeId | Integer | 是 | 门店ID |
| merchantId | Integer | 是 | 商户ID |
| orderSn | String | 否 | 订单编号 |
| previousStatus | String | 否 | 变更前状态 |
| currentStatus | String | 是 | 当前状态 |
| statusTime | String | 否 | 状态变更时间 |
| remark | String | 否 | 备注 |

**状态枚举**:

| 状态值 | 说明 |
|--------|------|
| CREATED | 待支付 |
| PAID | 已支付 |
| CANCEL | 已取消 |
| DELIVERY | 待发货 |
| DELIVERED | 已发货 |
| RECEIVED | 已收货/已取餐 |
|DELETED|已删除|
|REFUND|已退款|
**请求示例**:
```bash
curl -X POST 'https://meal-api.example.com/openapi/coffee/callback/order-status' \
  -H 'Content-Type: application/json' \
  -H 'X-Access-Key: your_access_key' \
  -H 'X-Timestamp: 1706077353000' \
  -H 'X-Nonce: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6' \
  -H 'X-Signature: {Base64编码的签名}' \
  -d '{
    "eventId": "evt_20260124112233001",
    "eventType": "ORDER_STATUS_CHANGE",
    "eventTime": "2026-01-24 11:22:33",
    "data": {
      "orderId": 12345,
      "merchantId": 1,
      "storeId": 1,
      "orderSn": "CF20260124001",
      "previousStatus": "PAID",
      "currentStatus": "RECEIVED",
      "statusTime": "2026-01-24 11:22:33",
      "remark": ""
    }
  }'
```

---


### 3.2 可取餐通知 (ORDER_READY)

**接口路径**: `POST /openapi/coffee/callback/order-ready`

**data 结构**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| orderId | Integer | 是 | 国鸿订单ID |
| storeId | Integer | 是 | 门店ID |
| merchantId | Integer | 是 | 商户ID |
| orderSn | String | 否 | 订单编号 |
| readyTime | String | 否 | 可取餐时间 |
| pickupCode | String | 否 | 取餐码 |
| estimatedWaitMinutes | Integer | 否 | 预计等待分钟数 |

**请求示例**:
```bash
curl -X POST 'https://meal-api.example.com/openapi/coffee/callback/order-ready' \
  -H 'Content-Type: application/json' \
  -H 'X-Access-Key: your_access_key' \
  -H 'X-Timestamp: 1706077800000' \
  -H 'X-Nonce: b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7' \
  -H 'X-Signature: {Base64编码的签名}' \
  -d '{
    "eventId": "evt_20260124113000001",
    "eventType": "ORDER_READY",
    "eventTime": "2026-01-24 11:30:00",
    "data": {
      "orderId": 12345,
      "storeId": 1,
      "merchantId": 1,
      "orderSn": "CF20260124001",
      "readyTime": "2026-01-24 11:30:00",
      "pickupCode": "A088",
      "estimatedWaitMinutes": 0
    }
  }'
```

---

### 3.3 退款状态变更 (PAY_STATUS_CHANGE)

**接口路径**: `POST /openapi/coffee/callback/pay-status`

**data 结构**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| orderId | Integer | 是 | 国鸿订单ID |
| storeId | Integer | 是 | 门店ID |
| merchantId | Integer | 是 | 商户ID |
| refundId | Integer| 是 | 退款ID|
| refundStatus | String | 是 | 退款状态 |
| refundAmount | Number | 否 | 退款金额（元） |
| refundType|String|是|退款类型（EXCHANGE-换货,RETURN-退款)|
| refundTime | String | 否 | 退款时间 |
| transactionId | String | 否 | 交易流水号 |
| reason | String | 否| 失败原因|

**退款状态枚举**:

| 状态值 | 说明 |
|--------|------|
| CREATED | 待审核 |
| APPROVED | 退款成功 |
| REJECT | 已拒绝 |
| CANCEL | 已取消 |
| FAILED |退款失败|

**请求示例**:
```bash
curl -X POST 'https://meal-api.example.com/openapi/coffee/callback/pay-status' \
  -H 'Content-Type: application/json' \
  -H 'X-Access-Key: your_access_key' \
  -H 'X-Timestamp: 1706077200000' \
  -H 'X-Nonce: c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8' \
  -H 'X-Signature: {Base64编码的签名}' \
  -d '{
    "eventId": "evt_20260124112000001",
    "eventType": "PAY_STATUS_CHANGE",
    "eventTime": "2026-01-24 11:20:00",
    "data": {
      "orderId": 12345,
      "merchantId": 1,
      "storeId": 1,
      "payStatus": "PAID",
      "payAmount": 28.00,
      "payTime": "2026-01-24 11:20:00",
      "payType": "BALANCE",
      "transactionId": "TXN20260124001"
    }
  }'
```

---

### 3.4 优惠券事件 (COUPON_EVENT)

**接口路径**: `POST /openapi/coffee/callback/coupon-event`

**data 结构**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| userId | Integer | 是 | 国鸿用户ID |
| couponId | Integer | 是 | 优惠券ID |
| userCouponId | Integer | 否 | 用户优惠券ID |
| action | String | 是 | 动作类型 |
| orderId | Integer | 否 | 关联订单ID（使用时） |
| actionTime | String | 否 | 动作时间 |

**动作类型枚举**:

| 状态值 | 说明 |
|--------|------|
| RECEIVED | 已领取 |
| USED | 已使用 |
| EXPIRED | 已过期 |
| REVOKED | 已撤销 |

**请求示例**:
```bash
curl -X POST 'https://meal-api.example.com/openapi/coffee/callback/coupon-event' \
  -H 'Content-Type: application/json' \
  -H 'X-Access-Key: your_access_key' \
  -H 'X-Timestamp: 1706076000000' \
  -H 'X-Nonce: d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9' \
  -H 'X-Signature: {Base64编码的签名}' \
  -d '{
    "eventId": "evt_20260124100000001",
    "eventType": "COUPON_EVENT",
    "eventTime": "2026-01-24 10:00:00",
    "data": {
      "userId": 100,
      "couponId": 5,
      "userCouponId": 1001,
      "action": "USED",
      "orderId": 12345,
      "actionTime": "2026-01-24 10:00:00"
    }
  }'
```

---

### 3.5 开票结果 (INVOICE_RESULT)

**接口路径**: `POST /openapi/coffee/callback/invoice-result`

**data 结构**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| orderId | Integer | 是 | 国鸿订单ID |
| storeId | Integer | 是 | 门店ID |
| merchantId | Integer | 是 | 商户ID |
| invoiceId | String | 否 | 发票ID |
| status | String | 是 | 开票状态 |
| invoiceNo | String | 否 | 发票号码（成功时返回） |
| invoiceCode | String | 否 | 发票代码（成功时返回） |
| invoiceUrl | String | 否 | 发票下载地址（成功时返回） |
| amount | Number | 否 | 开票金额（元） |
| failReason | String | 否 | 失败原因（失败时返回） |

**开票状态枚举**:

| 状态值 | 说明 |
|--------|------|
| SUCCESS | 开票成功 |
| FAILED | 开票失败 |

**请求示例（成功）**:
```bash
curl -X POST 'https://meal-api.example.com/openapi/coffee/callback/invoice-result' \
  -H 'Content-Type: application/json' \
  -H 'X-Access-Key: your_access_key' \
  -H 'X-Timestamp: 1706079600000' \
  -H 'X-Nonce: e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0' \
  -H 'X-Signature: {Base64编码的签名}' \
  -d '{
    "eventId": "evt_20260124120000001",
    "eventType": "INVOICE_RESULT",
    "eventTime": "2026-01-24 12:00:00",
    "data": {
      "orderId": 12345,
      "merchantId": 1,
      "storeId": 1,
      "invoiceId": "INV20260124001",
      "status": "SUCCESS",
      "invoiceNo": "12345678",
      "invoiceCode": "044001900111",
      "invoiceUrl": "https://invoice.example.com/download/12345678",
      "amount": 28.00,
      "failReason": null
    }
  }'
```

**请求示例（失败）**:
```json
{
  "eventId": "evt_20260124120000002",
  "eventType": "INVOICE_RESULT",
  "eventTime": "2026-01-24 12:00:00",
  "data": {
    "orderId": 12346,
    "merchantId":1,
    "store":1,
    "invoiceId": "INV20260124002",
    "status": "FAILED",
    "invoiceNo": null,
    "invoiceCode": null,
    "invoiceUrl": null,
    "amount": 28.00,
    "failReason": "发票额度不足"
  }
}
```

---

## 四、错误码说明

| HTTP 状态码 | 业务码 | 说明 | 处理建议 |
|------------|--------|------|---------|
| 200 | 00000 | 成功 | - |
| 200 | 00400 | eventId 不能为空 | 检查请求体中是否包含 eventId 字段 |
| 200 | 其他 | 业务错误 | 根据 msg 排查 |
| 400 | - | 参数错误 | 检查请求参数 |
| 401 | - | 签名验证失败 | 检查签名算法和密钥 |
| 500 | - | 服务器内部错误 | 稍后重试 |

---

## 五、重试机制

### 5.1 重试规则

| 场景 | 是否需要重试 |
|------|-------------|
| HTTP 状态码 200 + code=00000 | 否，处理成功 |
| HTTP 状态码 200 + code≠00000 | 否，业务错误需排查 |
| HTTP 状态码 4xx | 否，请求有误需排查 |
| HTTP 状态码 5xx | 是，服务器异常 |
| 网络超时 | 是 |

### 5.2 重试策略建议

- **重试次数**: 最多 3 次
- **重试间隔**: 指数退避，分别为 1s、5s、30s
- **超时时间**: 建议 10 秒

### 5.3 幂等性保证

- 我方通过 `eventId` 进行幂等处理
- 相同 `eventId` 的重复请求会直接返回成功，不会重复处理
- 请确保每个业务事件使用唯一的 `eventId`

---

## 六、接入清单

接入前请确认以下信息：

- [ ] 获取 `accessKey` 和 `secretKey`
- [ ] 确认回调地址白名单配置
- [ ] 完成签名算法实现
- [ ] 完成各事件类型的回调对接
- [ ] 完成重试机制实现

---

## 七、联系方式

如有技术问题，请联系：

- **技术对接人**: Shuhao Dai

---

